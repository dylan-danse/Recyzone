{% extends 'base.html.twig' %}

{% block body %}

<div class="col-md-offset-1 col-md-10">
<h1>Encodage déchets</h1>

    <br>
    <br>
    <br>

<div class="row">
    <form class="form-inline text-center">
        <div class="form-group">
            <label for="name">Nom</label>
            <input type="text" class="form-control" id="name" placeholder="John Doe">
        </div>
        <button type="button" onclick="searchHouseholds()" class="btn btn-primary">Rechercher</button>
    </form>
</div>

    <br>
    <br>
    <br>

<div class="row">
    <table id="usersTable" class="table table-striped table-hover">
        <thead>
            <tr>
                <th class="text-center">Nom</th>
                <th class="text-center">Adresse</th>
                <th class="text-center">Email</th>
                <th class="text-center">Username</th>
            </tr>
        </thead>
        <tbody id="bodyUsersTable">
        </tbody>
    </table>
</div>

    <br><br>
    <hr>
    <br><br>

<div class="row">
    <form class="form-inline text-center">
        <div class="form-group">
            <label for="wasteType">Type de déchet : </label>
            <select id="selectWasteType" class="form-control">
                <option selected value="Encombrants">Encombrants</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
                <option>5</option>
            </select>
        </div>
        <div class="form-group">

            <div class="input-group">
                <input type="number" class="form-control" id="inputWasteVolume" placeholder="0">
                <span class="input-group-addon">m3</span>
            </div>
        </div>
        <button type="button" onclick="addWaste()" class="btn btn-primary">Ajouter</button>
    </form>
</div>

    <br>
    <br>
    <br>

<div class="row">
    <table id="wasteTable" class="table table-striped table-hover">
        <thead>
            <tr>
                <th class="text-center">Type de déchet</th>
                <th class="text-center">Volume</th>
                <th class="text-center">Quota annuel utilisé</th>
                <th class="text-center">Selection</th>
            </tr>
        </thead>
        <tbody id="bodyWasteTable">
        </tbody>
    </table>
    <div class="col-md-offset-4 col-md-4">
        <button type="button" class="btn btn-danger btn-block" onclick="deleteSelectedRows()">Supprimer</button>
        <button type="button" class="btn btn-success btn-block" onclick="validateDeposit()">Confirmer</button>
    </div>
</div>

    <br>
    <br>


<div class="row">
    <div hidden id="alertSuccess" class="alert alert-success alert-dismissible text-center" role="alert">
        Dépôt effectué avec succès !
    </div>
    <div hidden id="alertError" class="alert alert-danger text-center" role="alert">
        Dépôt refusé...
    </div>
</div>

</div>


    <!-- reject if hour is not ok

    -->

    <script>
        function searchHouseholds() {
            var param = document.getElementById('name').value
            $.ajax({
                url: "./refreshUsersList",
                method: "post",
                data: {id: param}
            }).done(function(msg){
                refreshUsersList(msg);
            });
        }

        function refreshUsersList(msg){
            var tbody = '';
            $.each(JSON.parse(msg['data']), function(i, item){
               tbody +=  "<tr role='button' onclick='setSelectedUser(this)' class='text-center'> " +
                            "<td>" + item.firstName + " " + item.lastName +" </td> \
                            <td>" + item.houseNumber + " " + item.streetName + " - " + "code" + " " + item.city + "</td> \
                            <td>" + item.email + "</td> \
                            <td id='columnUsername'>" + item.username + "</td> \ " +
                        "</tr>";
            });

            if(tbody===''){
                tbody += '<tr class="text-center"><td colspan=\"4\">Aucun utilisateur correspondant au critère !</td></tr>';
            }

            $('#bodyUsersTable').html(tbody);
        }

        function deleteSelectedRows(){
            $('input:checkbox:checked').parents("tr").remove();
        }

        function validateDeposit(){
            userSelected = $('.danger #columnUsername').text();

            if(userSelected === null){
                alert('Veuillez choisir un utilisateur');
            }
            else{
                var array = [];
                $('#wasteTable > tbody  > tr').each(function(index, elem) {
                    array[array.length] =
                        {
                            type:$(this).find("#wasteType").text(),
                            volume: $(this).find("#wasteVolume").text(),
                            user: 1
                        }
                });
                $.ajax({
                    url: "./addWastes",
                    method: "post",
                    data: JSON.stringify(array),
                    contentType: "application/json"
                }).done(function(msg) {
                    $('#alertSuccess').slideUp(300).fadeIn(400).delay(1500).fadeOut();
                }).fail(function() {
                    $('#alertError').slideUp(300).fadeIn(400).delay(1500).fadeOut();
                });

            }
        }

        function setSelectedUser(row){
            var tds = document.querySelectorAll('#bodyUsersTable tr'), i;
            for(i = 0; i < tds.length; ++i) {
                tds[i].className = "text-center"
            }
            row.className += " danger";
        }

        function addWaste(){
            wasteType = $("#selectWasteType").val();
            wasteVolume = $("#inputWasteVolume").val();

            if(wasteType === "" ||wasteVolume === ""){
                alert("Veuillez entrer toute les informations nécessaires !");
                //TODO : show error details ?
            }
            else{
                //tbody = $('#bodyWasteTable').html();
                newLine = "<tr class=\"text-center\"> \
                            <td id=\"wasteType\">" + wasteType + "</td> \
                            <td id=\"wasteVolume\">" + wasteVolume + "m3</td> \
                            <td id=\"quota\">" + 10 + "%</td> \
                            <td><input type=\"checkbox\"></td> \
                        </tr>";
                tbody = $('#bodyWasteTable').append(newLine);
            }


        }

        $(".wasteTable input[type=checkbox]").on("change", function() {
            $(this).closest("tr").toggleClass("warning");
        }).filter(":checked").each(function() {
            $(this).closest("tr").addClass("warning");
        });

        $('input[type=checkbox]').change(function () {
            $(this).closest('tr').find('td').toggleClass('info', this.checked);
        });


        /*$(document).ready(function(){
            $('#usersTable').DataTable();
        });*/

    </script>


{% endblock %}

